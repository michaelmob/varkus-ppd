#!/bin/bash

cd $(dirname $0)/../
source env/bin/activate
cd project/

case "$1" in

	start)
		echo "Starting Viking"
		# Run Celery Cam
		../scripts/manage celerycam --frequency=30.0 &

		# Run Celery Worker
		celery worker --app=viking --beat --events &
		echo $! > celeryw.pid

		# Run Gunicorn
		gunicorn --workers=4 viking.wsgi &
		echo $! > gunicorn.pid

		# Wait for gunicorn to end
		wait $(cat gunicorn.pid)
		;;

	stop)
		echo "Stopping Viking"
		exit 0
		;;

	restart)
		../scripts/viking stop
		../scripts/viking start
		;;
	*)
		echo "Usage: viking {start|stop|restart}"
		exit 1
		;;

esac

# Kill Celerycam
kill $(cat celeryev.pid)

# Kill Celery worker
kill $(cat celeryw.pid)

# Kill Gunicorn
kill $(cat gunicorn.pid)

# Cleanup
rm celeryev.pid
rm celeryw.pid
rm gunicorn.pidp
exit 0