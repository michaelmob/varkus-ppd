#!/bin/bash

cd $(dirname $0)/../
source env/bin/activate
cd project/

case "$1" in

	start)
		echo "Starting Viking"
		# Run Celery Cam
		../scripts/manage celerycam --frequency=30.0 &

		# Run Celery Worker
		celery worker --app=viking --beat --events --pidfile=celeryw.pid &

		# Run uWSGI
		uwsgi --pidfile uwsgi.pid --socket 127.0.0.1:8000 --protocol=http --buffer-size=32768 --workers=5 --master --module viking.wsgi &
		uwsgi --pidfile uwsgi_ws.pid --http-socket 127.0.0.1:8001 --gevent 1000 --http-websockets --workers=2 --master --module viking.wsgi_websocket
		;;

	stop)
		echo "Stopping Viking"

		# Kill Celerycam
		kill $(cat celeryev.pid)

		# Kill Celery worker
		kill $(cat celeryw.pid)

		# Kill uWSGI
		kill -9 $(cat uwsgi.pid)
		kill -9 $(cat uwsgi_ws.pid)

		# Cleanup
		rm celeryev.pid
		rm celeryw.pid
		rm uwsgi.pid
		rm uwsgi_ws.pid
		;;

	restart)
		../scripts/viking stop
		../scripts/viking start
		;;
	*)
		echo "Usage: viking {start|stop|restart}"
		exit 1
		;;

esac

exit 0